# Template Integration

The `go-auth` package provides template helper functions that can be easily integrated with the `go-template` package for authentication-related template functionality.

## ðŸš€ New: Auto-Context Integration

For automatic user context registration, see [`AUTO_CONTEXT_INTEGRATION.md`](AUTO_CONTEXT_INTEGRATION.md) - this provides seamless user injection without manual context management.

The guide below covers the foundational template helpers that work with both manual and automatic user context patterns.

## Installation

Make sure you have both packages installed:

```bash
go get github.com/goliatone/go-auth
go get github.com/goliatone/go-template
```

## Basic Usage

### Option 1: Template Helpers Only

```go
import (
    "github.com/goliatone/go-auth"
    "github.com/goliatone/go-template"
)

// Create renderer with auth helpers
renderer, err := template.NewRenderer(
    template.WithBaseDir("./templates"),
    template.WithGlobalData(auth.TemplateHelpers()),
)

// Use in templates with user data
result, err := renderer.RenderTemplate("dashboard", map[string]any{
    "current_user": currentUser, // Your user object
})
```

### Option 2: Template Helpers with Global User

```go
// Get current user from session, JWT, etc.
currentUser := getCurrentUser(ctx)

// Create renderer with user already in global context
renderer, err := template.NewRenderer(
    template.WithBaseDir("./templates"),
    template.WithGlobalData(auth.TemplateHelpersWithUser(currentUser)),
)

// Templates automatically have access to current_user
result, err := renderer.RenderTemplate("dashboard", map[string]any{})
```

### Option 3: Request-Scoped Merge (Recommended)

```go
import (
    "github.com/goliatone/go-auth"
    "github.com/goliatone/go-router"
)

func render(ctx router.Context, name string, data router.ViewContext) error {
    return ctx.Render(name, auth.MergeTemplateData(ctx, data))
}
```

`MergeTemplateData` copies the request-specific helper map (current user + CSRF helpers) into your view data so `{{ csrf_field }}` always contains the token generated by the middleware. If CSRF middleware is disabled or misconfigured, the helper falls back to the placeholder strings and your tests will fail accordingly.

> Tip: Even if you only register `auth.TemplateHelpers()` globally, the `csrf_*` helpers evaluate lazily and read the token from the current request context, so the default go-auth templates render valid CSRF inputs without extra plumbing.

## Available Template Functions

### Authentication Helpers

| Function | Description | Example |
|----------|-------------|---------|
| `is_authenticated` | Check if user is logged in | `{% if current_user\|is_authenticated %}` |
| `has_role` | Check if user has specific role | `{% if current_user\|has_role:"admin" %}` |
| `is_at_least` | Check if user role meets minimum level | `{% if current_user\|is_at_least:"member" %}` |

### Permission Helpers

| Function | Description | Example |
|----------|-------------|---------|
| `can_read` | Check if user can read resources | `{% if current_user\|can_read %}` |
| `can_edit` | Check if user can edit resources | `{% if current_user\|can_edit %}` |
| `can_create` | Check if user can create resources | `{% if current_user\|can_create %}` |
| `can_delete` | Check if user can delete resources | `{% if current_user\|can_delete %}` |
| `can_access` | Check specific action permission | `{% if current_user\|can_access:"edit" %}` |

### Role Constants

The `roles` object provides easy access to role constants:

```html
<!-- Check against role constants -->
{% if current_user.user_role == roles.admin %}
    <div class="admin-panel">Admin Content</div>
{% endif %}

<!-- List all available roles -->
{% for role_name, role_value in roles %}
    <option value="{{ role_value }}">{{ role_name|title }}</option>
{% endfor %}
```

Available role constants:
- `roles.guest` â†’ "guest"
- `roles.member` â†’ "member"  
- `roles.admin` â†’ "admin"
- `roles.owner` â†’ "owner"

## Template Examples

### Navigation Menu

```html
<nav class="navbar">
  {% if current_user|is_authenticated %}
    <span class="user-info">
      Hello, {{ current_user.first_name }}! 
      ({{ current_user.user_role|title }})
    </span>
    
    <ul class="nav-menu">
      <li><a href="/dashboard">Dashboard</a></li>
      
      {% if current_user|is_at_least:"member" %}
        <li><a href="/profile">My Profile</a></li>
      {% endif %}
      
      {% if current_user|can_create %}
        <li><a href="/posts/create">Create Post</a></li>
      {% endif %}
      
      {% if current_user|has_role:"admin" %}
        <li><a href="/admin">Admin Panel</a></li>
      {% endif %}
      
      {% if current_user|has_role:"owner" %}
        <li><a href="/system">System Settings</a></li>
      {% endif %}
    </ul>
    
    <a href="/logout" class="logout-btn">Logout</a>
  {% else %}
    <div class="auth-buttons">
      <a href="/login" class="btn btn-primary">Login</a>
      <a href="/register" class="btn btn-secondary">Register</a>
    </div>
  {% endif %}
</nav>
```

### Content with Permission Checks

```html
<div class="post">
  <h2>{{ post.title }}</h2>
  <p>{{ post.content }}</p>
  
  {% if current_user|is_authenticated %}
    <div class="post-actions">
      {% if current_user|can_edit %}
        <a href="/posts/{{ post.id }}/edit" class="btn btn-secondary">Edit</a>
      {% endif %}
      
      {% if current_user|can_delete %}
        <button class="btn btn-danger" onclick="deletePost('{{ post.id }}')">Delete</button>
      {% endif %}
      
      {% if current_user|has_role:"admin" %}
        <a href="/posts/{{ post.id }}/moderate" class="btn btn-warning">Moderate</a>
      {% endif %}
    </div>
  {% endif %}
</div>
```

### Admin Panel

```html
{% if current_user|has_role:"admin" %}
<div class="admin-panel">
  <h3>Administration</h3>
  
  <div class="admin-sections">
    {% if current_user|can_create %}
      <section class="admin-section">
        <h4>Content Management</h4>
        <a href="/admin/posts/create" class="btn">Create Post</a>
        <a href="/admin/pages/create" class="btn">Create Page</a>
      </section>
    {% endif %}
    
    {% if current_user|is_at_least:"admin" %}
      <section class="admin-section">
        <h4>User Management</h4>
        <a href="/admin/users" class="btn">Manage Users</a>
        <a href="/admin/roles" class="btn">Manage Roles</a>
      </section>
    {% endif %}
    
    {% if current_user|has_role:"owner" %}
      <section class="admin-section">
        <h4>System Settings</h4>
        <a href="/admin/settings" class="btn">System Settings</a>
        <a href="/admin/backup" class="btn">Backup & Restore</a>
      </section>
    {% endif %}
  </div>
</div>
{% else %}
<div class="access-denied">
  <h3>Access Denied</h3>
  <p>You need admin privileges to access this area.</p>
</div>
{% endif %}
```

### Form Controls

```html
<form class="user-form">
  <div class="form-group">
    <label for="title">Post Title</label>
    <input type="text" id="title" name="title" value="{{ post.title }}"
           {% if not current_user|can_edit %}disabled{% endif %}>
  </div>
  
  <div class="form-group">
    <label for="content">Content</label>
    <textarea id="content" name="content" 
              {% if not current_user|can_edit %}disabled{% endif %}>{{ post.content }}</textarea>
  </div>
  
  {% if current_user|can_edit %}
    <button type="submit" class="btn btn-primary">
      {% if current_user|can_create %}Create{% else %}Update{% endif %} Post
    </button>
  {% endif %}
  
  {% if current_user|can_delete and post.id %}
    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
      Delete Post
    </button>
  {% endif %}
</form>
```

## Role Hierarchy

The helper functions understand the role hierarchy defined in go-auth:

1. **Guest** (`guest`) - Can read only
2. **Member** (`member`) - Can read and edit  
3. **Admin** (`admin`) - Can read, edit, and create
4. **Owner** (`owner`) - Can read, edit, create, and delete

Use `is_at_least` to check minimum role requirements:

```html
{% if current_user|is_at_least:"member" %}
  <!-- Available to member, admin, and owner -->
{% endif %}

{% if current_user|is_at_least:"admin" %}
  <!-- Available to admin and owner only -->
{% endif %}
```

## Data Type Support

The template helpers work with different user data types:

1. **Go structs**: `*User` or `User` objects
2. **JSON data**: `map[string]any` (converted via go-template's JSON marshaling)
3. **Nil values**: Safely handles nil/empty users

This flexibility allows the helpers to work regardless of how your user data is structured or converted.

## Error Handling

All helper functions are designed to be safe:

- Return `false` for any invalid or nil user data
- Handle type conversion gracefully
- Never panic on unexpected data types
- Provide sensible defaults for edge cases

## Integration Examples

See the complete working example in [`examples/template_integration_example.go`](examples/template_integration_example.go).
