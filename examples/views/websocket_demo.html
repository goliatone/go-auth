{% extends "layouts/auth.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-6xl">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .user-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            margin-left: 10px;
        }

        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .connecting { background-color: #fff3cd; color: #856404; }

        .chat-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chat-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
            background: #fafafa;
            border-radius: 5px;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background: white;
            border-left: 4px solid #667eea;
        }

        .message.admin {
            border-left-color: #ff6b6b;
            background: #fff5f5;
        }

        .message.system {
            border-left-color: #4ecdc4;
            background: #f0fffe;
            font-style: italic;
        }

        .message.error {
            border-left-color: #ff4757;
            background: #ffe8e8;
        }

        .message-meta {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-primary { background-color: #667eea; color: white; }
        .btn-primary:hover { background-color: #5a67d8; }

        .btn-danger { background-color: #ff6b6b; color: white; }
        .btn-danger:hover { background-color: #ff5252; }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .control-section {
            margin-bottom: 20px;
        }

        .users-list {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-tag {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background-color: #e3f2fd;
            border-radius: 12px;
            font-size: 0.9em;
        }

        .user-tag.admin {
            background-color: #ffebee;
            color: #d32f2f;
        }

        @media (max-width: 768px) {
            .chat-container {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <div class="header">
        <h1>üöÄ WebSocket Authentication Demo</h1>
        <p>Real-time communication with JWT-based authentication and role-based permissions</p>
    </div>

    <div class="user-info">
        <strong>üë§ Authenticated User:</strong> {{ record.username }} ({{ record.email }})
        <strong>üîê Role:</strong> {% if has_role(current_user, "admin") %}<span style="color: #d32f2f;">Admin</span>{% else %}<span style="color: #1976d2;">User</span>{% endif %}
        <span id="connectionStatus" class="status disconnected">Disconnected</span>
    </div>

    <div class="chat-container">
        <div class="chat-section">
            <h3>üí¨ Chat Messages</h3>
            <div id="chatMessages" class="messages"></div>
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="Type your message..." disabled>
                <button id="sendMessage" class="btn btn-primary" disabled>Send</button>
            </div>
        </div>

        <div class="chat-section">
            <h3>üì¢ System Events</h3>
            <div id="systemMessages" class="messages"></div>
            <div style="font-size: 0.9em; color: #666;">
                System events: user connections, disconnections, admin actions, etc.
            </div>
        </div>
    </div>

    <div class="controls">
        <h3>üéõÔ∏è Controls</h3>

        <div class="control-section">
            <h4>Connection</h4>
            <button id="connectBtn" class="btn btn-primary">Connect to WebSocket</button>
            <button id="disconnectBtn" class="btn btn-danger" disabled>Disconnect</button>
        </div>

        {% if has_role(current_user, "admin") %}
        <div class="control-section">
            <h4>üîë Admin Commands</h4>
            <div class="input-group">
                <input type="text" id="adminCommandInput" placeholder="Enter admin command..." disabled>
                <button id="sendAdminCommand" class="btn btn-danger" disabled>Execute</button>
            </div>
            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                Try commands like: "broadcast", "maintenance", "user-count"
            </div>
        </div>
        {% endif %}
    </div>

    <div class="users-list">
        <h3>üë• Connected Users</h3>
        <div id="connectedUsers">No users connected</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ WebSocket Demo script loaded and DOM is ready.');

        // Template variables
        const isAdmin = {% if has_role(current_user, "admin") %}true{% else %}false{% endif %};
        const wsUrl = '{{ wsUrl }}';
        const wsToken = '{{ token }}';

        // Debug: Log token information
        console.log('WebSocket Debug Info:');
        console.log('- wsUrl:', wsUrl + '?token=' + wsToken);
        console.log('- wsToken:', wsToken);
        console.log('- wsToken length:', wsToken ? wsToken.length : 'undefined');
        console.log('- wsToken type:', typeof wsToken);

        if (!wsToken || wsToken === '') {
            console.error('‚ùå WebSocket token is empty or undefined!');
            addSystemMessage('‚ùå Error: WebSocket token is missing. Please refresh the page.', 'error');
        } else {
            console.log('‚úÖ WebSocket token appears to be present');
        }

        let socket = null;
        let isConnected = false;
        let connectedUsers = new Set();

        // DOM elements
        const connectionStatus = document.getElementById('connectionStatus');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessage');
        const chatMessages = document.getElementById('chatMessages');
        const systemMessages = document.getElementById('systemMessages');
        const connectedUsersDiv = document.getElementById('connectedUsers');

        // Admin elements (will be null if not admin)
        const adminCommandInput = document.getElementById('adminCommandInput');
        const sendAdminCommandBtn = document.getElementById('sendAdminCommand');

        if (!connectBtn) {
            console.error('‚ùå CRITICAL: Could not find the #connectBtn element. The script cannot proceed.');
            return;
        } else {
            console.log('‚úÖ Connect button found.');
        }


        // WebSocket connection
        function connect() {
            console.log('üîµ "Connect" button clicked. Initiating WebSocket connection...');
            // We are not using token in query, we will send it in a message.
            const wsUrlWithToken = wsUrl + '?token=' + wsToken;

            updateConnectionStatus('connecting');
            addSystemMessage('Connecting to WebSocket server...', 'system');

            //socket = new WebSocket(wsUrl);
            socket = new WebSocket(wsUrlWithToken);

            socket.onopen = function(event) {
                isConnected = true;
                updateConnectionStatus('connected');
                addSystemMessage('‚úÖ Connected to WebSocket server successfully! Authentication happening automatically...', 'system');
                console.log('üîó WebSocket connection opened, expecting immediate auth_success message');
            };

            socket.onmessage = function(event) {
                console.log('üì® RAW MESSAGE RECEIVED:', event.data);
                try {
                    const data = JSON.parse(event.data);
                    console.log('üì® PARSED MESSAGE:', data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Failed to parse WebSocket message:', error);
                    addSystemMessage(`‚ùå Error parsing message: ${error.message}`, 'error');
                }
            };

            socket.onclose = function(event) {
                isConnected = false;
                updateConnectionStatus('disconnected');
                addSystemMessage(`üîå Connection closed. Code: ${event.code}, Reason: ${event.reason || 'Unknown'}`, 'system');
                disableControls();

                // Clear connected users when disconnected
                connectedUsers.clear();
                updateConnectedUsersList();
            };

            socket.onerror = function(error) {
                addSystemMessage(`‚ùå WebSocket error: ${error.message || 'Connection error'}`, 'error');
            };
        }

        function disconnect() {
            if (socket && isConnected) {
                socket.close();
            }
        }

        function sendChatMessage() {
            const message = messageInput.value.trim();
            if (message && isConnected) {
                socket.send(JSON.stringify({
                    event: 'chat_message',
                    data: { text: message }
                }));
                messageInput.value = '';
            }
        }

        function sendAdminCommand() {
            if (!isAdmin) return;
            const command = adminCommandInput.value.trim();
            if (command && isConnected) {
                socket.send(JSON.stringify({
                    event: 'admin_command',
                    data: { command: command }
                }));
                adminCommandInput.value = '';
            }
        }

        function handleWebSocketMessage(data) {
            console.log('üîÑ HANDLING MESSAGE TYPE:', data.type, 'DATA:', data);
            switch(data.type) {
                case 'auth_required':
                    console.log('üîê AUTH REQUIRED RECEIVED:', data);
                    addSystemMessage(`üîê ${data.message}. Sending token now...`, 'system');
                    // Send authentication token now that it has been requested
                    const authMessage = {
                        event: 'authenticate',
                        data: { token: wsToken }
                    };
                    console.log('üì§ SENDING AUTH MESSAGE:', authMessage);
                    socket.send(JSON.stringify(authMessage));
                    break;
                case 'auth_success':
                    addSystemMessage(`‚úÖ ${data.message}`, 'system');
                    console.log('Authentication successful:', data);
                    enableControls(); // Enable controls after successful authentication
                    break;
                case 'auth_error':
                    addSystemMessage(`‚ùå Authentication failed: ${data.message}`, 'error');
                    console.error('Authentication failed:', data);
                    // Optionally close connection on auth failure
                    // disconnect();
                    break;
                case 'welcome':
                    addSystemMessage(`üéâ Welcome! User ID: ${data.user_id}, Role: ${data.role}`, 'system');
                    break;

                case 'new_message':
                    addChatMessage(data.user_id, data.message, data.timestamp, data.role);
                    break;

                case 'admin_announcement':
                    addSystemMessage(`üì¢ Admin Announcement: ${data.message}`, 'admin');
                    break;

                case 'error':
                    addSystemMessage(`‚ùå Error: ${data.message}`, 'error');
                    break;

                default:
                    // Handle events
                    if (data.user_id) {
                        switch(data.type || (data.event === 'user_connected' ? 'user_connected' : 'user_disconnected')) {
                            case 'user_connected':
                                connectedUsers.add(`${data.user_id} (${data.role})`);
                                addSystemMessage(`üëã ${data.user_id} joined (${data.role})`, 'system');
                                updateConnectedUsersList();
                                break;

                            case 'user_disconnected':
                                // Remove user (try different formats)
                                connectedUsers.delete(`${data.user_id} (admin)`);
                                connectedUsers.delete(`${data.user_id} (user)`);
                                connectedUsers.delete(`${data.user_id} (moderator)`);
                                addSystemMessage(`üëã ${data.user_id} left`, 'system');
                                updateConnectedUsersList();
                                break;
                        }
                    } else {
                        console.log('Unhandled message:', data);
                        addSystemMessage(`üì® Received: ${JSON.stringify(data)}`, 'system');
                    }
                    break;
            }
        }

        function addChatMessage(userId, message, timestamp, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role === 'admin' ? 'admin' : ''}`;
            messageDiv.innerHTML = `
                <div class="message-meta">
                    <strong>${userId}</strong> (${role}) ‚Ä¢ ${new Date(timestamp).toLocaleTimeString()}
                </div>
                <div>${escapeHtml(message)}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addSystemMessage(message, type = 'system') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <div class="message-meta">${new Date().toLocaleTimeString()}</div>
                <div>${escapeHtml(message)}</div>
            `;
            systemMessages.appendChild(messageDiv);
            systemMessages.scrollTop = systemMessages.scrollHeight;
        }

        function updateConnectionStatus(status) {
            connectionStatus.className = `status ${status}`;
            connectionStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }

        function enableControls() {
            connectBtn.disabled = true;
            disconnectBtn.disabled = false;
            messageInput.disabled = false;
            sendMessageBtn.disabled = false;

            if (isAdmin && adminCommandInput && sendAdminCommandBtn) {
                adminCommandInput.disabled = false;
                sendAdminCommandBtn.disabled = false;
            }
        }

        function disableControls() {
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            messageInput.disabled = true;
            sendMessageBtn.disabled = true;

            if (isAdmin && adminCommandInput && sendAdminCommandBtn) {
                adminCommandInput.disabled = true;
                sendAdminCommandBtn.disabled = true;
            }
        }

        function updateConnectedUsersList() {
            if (connectedUsers.size === 0) {
                connectedUsersDiv.innerHTML = 'No users connected';
            } else {
                const userTags = Array.from(connectedUsers).map(user => {
                    const isAdmin = user.includes('(admin)');
                    return `<span class="user-tag ${isAdmin ? 'admin' : ''}">${user}</span>`;
                }).join('');
                connectedUsersDiv.innerHTML = userTags;
            }
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Event listeners
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        sendMessageBtn.addEventListener('click', sendChatMessage);

        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        if (isAdmin && sendAdminCommandBtn && adminCommandInput) {
            sendAdminCommandBtn.addEventListener('click', sendAdminCommand);
            adminCommandInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendAdminCommand();
                }
            });
        }

        // Initial setup
        addSystemMessage('üöÄ WebSocket Demo loaded. Click "Connect" to start!', 'system');
    });
</script>
{% endblock %}
